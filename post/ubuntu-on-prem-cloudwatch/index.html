<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="
  
      Can I replace a local Prometheus with AWS CloudWatch?  And include syslog monitoring as well?  Yes, I can.  But it was a PITA to set up.  Here&rsquo;s how.
    ">
  <meta name="generator" content="Hugo 0.129.0">

  <meta property="og:title" content="Using CloudWatch for On-Premise Ubuntu Servers" />
  <meta name="twitter:title" content="Using CloudWatch for On-Premise Ubuntu Servers" />

  <meta property="og:url" content="https://blog.herlein.com/post/ubuntu-on-prem-cloudwatch/" />
  
    <meta name="twitter:card" content="summary">
  

  <meta name="twitter:site" content="Greg Herlein">
  <meta name="twitter:creator" content="Herlein">
  
    <meta name="twitter:description" content="Can I replace a local Prometheus with AWS CloudWatch?  And include syslog monitoring as well?  Yes, I can.  But it was a PITA to set up.  Here&rsquo;s how." />
  

  
  <link rel="preconnect" href="https://s.ytimg.com">
  <link rel="preconnect" href="https://i.imgur.com">

  <title>Using CloudWatch for On-Premise Ubuntu Servers &middot; Greg Herlein</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.5/pure-min.css" media="screen">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.5/grids-responsive-min.css" media="screen">
  <link rel="stylesheet" href="https://blog.herlein.com/css/side-menu.css" media="screen">

  <link rel="stylesheet" href="https://blog.herlein.com/css/blackburn.css" media="screen">
  <link rel="stylesheet" href="https://blog.herlein.com/css/dw-burn.css" media="screen">
  <link rel="stylesheet" href="https://blog.herlein.com/css/dw-menu.css" media="screen">
  <link rel="stylesheet" href="https://blog.herlein.com/css/vars.css" media="screen">
  <link rel="stylesheet" href="https://blog.herlein.com/css/menu-x.css" media="screen">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML">
  </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$']],
      displayMath: [['$$','$$']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
    CommonHTML: { linebreaks: { automatic: true } },
    "HTML-CSS": { linebreaks: { automatic: true } },
          SVG: { linebreaks: { automatic: true } }    
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

 
 

  
  <link async rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css" media="screen">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.highlightAll();</script>
  

  <link rel="shortcut icon" href="https://blog.herlein.com/img/favicon.ico" type="image/x-icon" />

  
  
  

  
  
</head>


<body>
  <div id="layout">
    
<a href="#menu" class="menu-link" id="menuLink" aria-label="Go to menu of this website">
  <s class="bar"></s><s class="bar"></s>
</a>
<div id="menu">

  

  <a class="pure-menu-heading brand" href="https://blog.herlein.com/">Herlein</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
        <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://blog.herlein.com/"><i class='fa fa-home fa-fw'></i><span>Home</span></a>
        </li>
      
        <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://blog.herlein.com/post/"><i class='fa fa-list fa-fw'></i><span>Posts</span></a>
        </li>
      
        <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://blog.herlein.com/about/"><i class='fa fa-user fa-fw'></i><span>About Me</span></a>
        </li>
      
        <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://blog.herlein.com/projects/"><i class='fa fa-user fa-fw'></i><span>Projects</span></a>
        </li>
      
        <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://blog.herlein.com/resume/"><i class='fa fa-user fa-fw'></i><span>Resume</span></a>
        </li>
      
        <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://blog.herlein.com/staffing/"><i class='fa fa-user fa-fw'></i><span>Staffing</span></a>
        </li>
      
    </ul>
  </div>

  
<div class="pure-menu social">
    <ul class="pure-menu-list">

      
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://linkedin.com/in/gherlein" rel="me external noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i><span>LinkedIn</span></a>
      </li>
      
  
      
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://github.com/gherlein" rel="me external noopener" target="_blank"><i class="fab fa-github-square fa-fw"></i><span>GitHub</span></a>
      </li>
      

      

      

    </ul>
  </div>


  <div class="copyright-small">
  Built with <a href="https://gohugo.io/" rel="external noopener" target="_blank">Hugo</a>
</div>
<div class="copyright-small">
  W/ <a href="https://github.com/dwy6626/dw-favored-blackburn" rel="external noopener" target="_blank">DW-Favored-Blackburn</a>
</div>
<div class="copyright-small">
  Based on <a href="https://github.com/yoshiharuyamashita/blackburn" rel="external noopener" target="_blank">Blackburn</a>
</div>
<div class="copyright-small">
  and <a href="https://purecss.io/" rel="external noopener" target="_blank">Pure CSS</a>
</div>
<div class="copyright-small">
  Icons <a href="https://fontawesome.com" rel="external noopener" target="_blank">Font Awesome</a>
</div>

<div class="copyright-small">
  <a href="https://blog.herlein.com/">
    &copy; 2018-2025. All rights reserved.
  </a>
</div>

</div>


    <div id="main">
      <div class="header">
        
          <h1>
            
              Using CloudWatch for On-Premise Ubuntu Servers
            
          </h1>
          <h2>
            
          </h2>
        
      </div>
      <div class="aside-container">
        
  <div id="toc-aside" style="display: none;">
    
      <link rel="stylesheet" href="https://blog.herlein.com/css/aside-toc.css" media="screen">
<script src="https://blog.herlein.com/js/toc.js"></script>
<div class="toc">
  <aside>
    <summary>Table of Contents</summary>
    <div class="toc-item">
      <p><a rel='tag' href="#">Using CloudWatch for On-Premise Ubuntu Servers</a></p>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#why-cloudwatch">Why CloudWatch?</a></li>
    <li><a href="#cloudwatch-agent">CloudWatch Agent</a></li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#configuration">Configuration</a></li>
  </ul>
</nav>
    </div>
  </aside>
</div>

    
  </div>

      </div>
      <div class="content">
        
  <ul class="post-meta">
  <li>
    <i class="fa fa-calendar fa-fw"></i>
    <span>
      <time>04 Nov 2020, 00:00</time>
    </span>
  </li>
</ul>




<ul class="post-meta">
  

  
    
      <a href='https://blog.herlein.com/tags/cloud'>
        <li>
          <i class="fas fa-tag fa-fw"></i>
          <span>cloud</span>
        </li>
      </a>
    
      <a href='https://blog.herlein.com/tags/aws'>
        <li>
          <i class="fas fa-tag fa-fw"></i>
          <span>aws</span>
        </li>
      </a>
    
      <a href='https://blog.herlein.com/tags/cloudwatch'>
        <li>
          <i class="fas fa-tag fa-fw"></i>
          <span>cloudwatch</span>
        </li>
      </a>
    
      <a href='https://blog.herlein.com/tags/ubuntu'>
        <li>
          <i class="fas fa-tag fa-fw"></i>
          <span>ubuntu</span>
        </li>
      </a>
    
      <a href='https://blog.herlein.com/tags/monitoring'>
        <li>
          <i class="fas fa-tag fa-fw"></i>
          <span>monitoring</span>
        </li>
      </a>
    
      <a href='https://blog.herlein.com/tags/syslogs'>
        <li>
          <i class="fas fa-tag fa-fw"></i>
          <span>syslogs</span>
        </li>
      </a>
    
  
</ul>


  <div id="toc-top" style="display: none;">
    
      <div class="toc">
        <aside>
          <details>
            <summary>Table of Contents</summary>
            <div class="toc-item">
              <nav id="TableOfContents">
  <ul>
    <li><a href="#why-cloudwatch">Why CloudWatch?</a></li>
    <li><a href="#cloudwatch-agent">CloudWatch Agent</a></li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#configuration">Configuration</a></li>
  </ul>
</nav>
            </div>
          </details>
        </aside>
      </div>
    
  </div>
  <p>Can I replace a local Prometheus with AWS CloudWatch?  And include syslog monitoring as well?  Yes, I can.  But it was a PITA to set up.  Here&rsquo;s how.</p>
<h2 id="why-cloudwatch">Why CloudWatch?</h2>
<p>To learn, of course!  Well, that and a practical test.  It&rsquo;s an experiment.  I&rsquo;ve run a local server for years and had it be my syslog server and handle my monitoring.  Yes, I&rsquo;m a geek.  I use Ubiquity Unifi equipment and I have the controller configured to remote syslog so I get all the AP events.  I also run my own internal DHCP for static mapping of MAC to IP, and internal DNS and Reverse DNS.  I used to have DHCP/DNS on a different small server.</p>
<p>But running these servers costs me money, in electrical costs.  I decided to see if could get comparable or better functionality using CloudWatch, and then compare the costs too.  This post will be just about the first steps of setting things up.  Later I&rsquo;ll blog about more details on the service, and evaluate the costs.  At this point even if it&rsquo;s more money I&rsquo;m going through this exercise, since I really want to understand how this would work.</p>
<p>Of course, to really evaluate the two options I&rsquo;ll apply the <a href="https://aws.amazon.com/blogs/apn/the-5-pillars-of-the-aws-well-architected-framework/">5 pillars of the Well Architected Framework</a> - CORPS in short (Cost, Operational Excellence, Reliability, Performance, Security).  But that&rsquo;s another blog post.  Today is just getting the agent set up!</p>
<h2 id="cloudwatch-agent">CloudWatch Agent</h2>
<p>You would think this is an easy slam dunk.  AWS has a <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-on-premise.html">document describing how to do this</a>.  But while it says you can download it using SystemManager or an S3 link, the docs don&rsquo;t actually include a link.  And it&rsquo;s very much written from the perspective that you will use SystemManager.</p>
<p>But I&rsquo;m not.  All I want to do is install the Agent locally, configure it, and have it send it&rsquo;s logs and metrics off to CloudWatch.  Turns out that was fraught with difficulty.</p>
<p>Google searches mostly turned up more on how to do it with SystemManager, or how to do it on an EC2 instance.  I did find <a href="https://www.petefreitag.com/item/868.cfm">this post</a> that was groundbreaking for me.  But it had some errors and misses too.</p>
<h2 id="installation">Installation</h2>
<p>The [agent debian package ](<a href="https://s3.amazonaws.com/amazoncloudwatch-agent">https://s3.amazonaws.com/amazoncloudwatch-agent</a><br>
/debian/amd64/latest/amazon-cloudwatch-agent.deb) is installed the usual way.  I&rsquo;ve <a href="https://github.com/gherlein/cloudwatch-install/blob/master/install.sh">created a script to do most of it for you</a> but here&rsquo;s the steps.  You need to be root.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># run this as root</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># download it</span>
</span></span><span style="display:flex;"><span>curl -o /root/amazon-cloudwatch-agent.deb https://s3.amazonaws.com/amazoncloudwatch-agent<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>/debian/amd64/latest/amazon-cloudwatch-agent.deb
</span></span><span style="display:flex;"><span><span style="color:#75715e"># install it</span>
</span></span><span style="display:flex;"><span>dpkg -i -E /root/amazon-cloudwatch-agent.deb
</span></span></code></pre></div><p>This will create a user &ldquo;cwagent&rdquo; but does nothing to configure anything.  You next do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># add the cwagent user to the adm group so it can read logs</span>
</span></span><span style="display:flex;"><span>usermod -aG adm cwagent
</span></span><span style="display:flex;"><span><span style="color:#75715e"># configure the user credentials</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /home/cwagent/.aws/credentials
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[AmazonCloudWatchAgent]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">aws_access_key_id = aaaaaaaa
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">aws_secret_access_key = bbbbbbbb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># configure the user region</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /home/cwagent/.aws/config
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[AmazonCloudWatchAgent]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">output = text
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">region = us-east-1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get your own IAM creds for an IAM user and edit the file</span>
</span></span><span style="display:flex;"><span>nano /home/cwagent/.aws/credentials
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set ownership</span>
</span></span><span style="display:flex;"><span>chmod -R cwagent.cwagent /home/cwagent
</span></span></code></pre></div><p>Moving forward requires two things:  you need to <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html">install the AWS CLI</a> on your Ubuntu server, and you need to create an IAM user &ldquo;cwagent.&rdquo;  The <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/create-iam-roles-for-cloudwatch-agent.html">AWS docs for the latter</a> are quite clear and easy to follow.  When you have the AWS credentials for the new user, you need to add those to the new user on your ubuntu server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># get your own IAM creds for an IAM user and edit the file</span>
</span></span><span style="display:flex;"><span>nano /home/cwagent/.aws/credentials
</span></span></code></pre></div><p>Replace nano with your favorite editor, as desired.</p>
<p>Oh, set the region you want as well.  The example uses us-east-1 but choose the right region for you.</p>
<p>Note that you also need to chown the files, since you did all this editing as root.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># set ownership</span>
</span></span><span style="display:flex;"><span>chmod -R cwagent.cwagent /home/cwagent
</span></span></code></pre></div><p>Now, this next step is important.  If you don&rsquo;t have collectd installed and you configure to collect metrics (see below) then the agent will just hang and not do anything.  Not even send syslogs.  I need to test this to ensure I can reproduce it, but it seems like a bug.  The logs should at least say something about it but they don&rsquo;t.  More on the agent logs later.</p>
<h2 id="configuration">Configuration</h2>
<p>This is where I had a lot of head scratching.  The <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/create-cloudwatch-agent-configuration-file-wizard.html">documentation from AWS</a> is flat oout WRONG.  I have submitted feedback to the page on what I found.  Here&rsquo;s the scoop:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># run the wizard</span>
</span></span><span style="display:flex;"><span>/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-wizard
</span></span><span style="display:flex;"><span><span style="color:#75715e"># move the configuration file to the right place and name it properly</span>
</span></span><span style="display:flex;"><span>mv /opt/aws/amazon-cloudwatch-agent/bin/config.json <span style="color:#ae81ff">\ </span>/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
</span></span></code></pre></div><p>Running the wizard asks you a set of questions and creates a config file.  However you need to move it to the etc folder and rename it in order for the agent to be able to find it.  The docs on the sections of the file seem pretty accurate, and it&rsquo;s self explanatory really.  I just accepted defaults, except for specifying the actual syslog file.</p>
<p>Again, make sure you installed collectd.  Otherwise, the agent just hangs.</p>
<p>Now you are ready.  Restart the service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># restart the service</span>
</span></span><span style="display:flex;"><span>service amazon-cloudwatch-agent restart
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check status</span>
</span></span><span style="display:flex;"><span>service amazon-cloudwatch-agent	status
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check the logs</span>
</span></span><span style="display:flex;"><span>tail -f /var/log/amazon/amazon-cloudwatch-agent/amazon-cloudwatch-agent.log
</span></span></code></pre></div><p>You want to see something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2020-11-04T14:26:44Z I! Started the statsd service on :8125
</span></span><span style="display:flex;"><span>2020-11-04T14:26:44Z I! <span style="color:#f92672">[</span>inputs.socket_listener<span style="color:#f92672">]</span> Listening on udp://127.0.0.1:25826
</span></span><span style="display:flex;"><span>2020-11-04T14:26:44Z I! Statsd listener listening on:  <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:8125
</span></span><span style="display:flex;"><span>2020-11-04T14:26:45Z I! will use file based credentials provider
</span></span><span style="display:flex;"><span>2020-11-04T14:26:45Z I! <span style="color:#f92672">[</span>logagent<span style="color:#f92672">]</span> piping log from syslog/sol1<span style="color:#f92672">(</span>/var/log/messages<span style="color:#f92672">)</span> to cloudwatchlogs
</span></span></code></pre></div><p>Now you know that the agent is sending stuff to CloudWatch.  Your next step is to go there and configure dashboards, etc.  That&rsquo;s for another post!</p>
<p><a title="Google Analytics Alternative" href="https://clicky.com/101366448"><img alt="Clicky" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a></p>
<script async src="//static.getclicky.com/101366448.js"></script>
<p><noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101366448ns.gif" /></p></noscript></p>

  


  <div class="copyright">
    This article is licensed under
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>
    .
  </div>

  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://blog.herlein.com/post/disposability/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://blog.herlein.com/post/disposability/">Disposability - the Missing ility</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://blog.herlein.com/post/power/">Power Costs</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://blog.herlein.com/post/power/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  


      </div>
    </div>
  </div>

  <script src="https://blog.herlein.com/js/ui.js"></script>
<script src="https://blog.herlein.com/js/menus.js"></script>









  </body>
</html>
